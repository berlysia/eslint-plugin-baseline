# eslint-plugin-baseline

ブラウザの機能サポート状況に基づいて、コードがユーザーの期待するBaselineを満たしているかを検証するESLintプラグイン。

## 概要

このプラグインは、[compute-baseline](https://www.npmjs.com/package/compute-baseline)を利用して、コードで使用されている機能が指定された基準日時点で十分にサポートされているかをチェックします。

## 進捗状況

### 完了済み

- [x] 基本設計の確立
  - [x] 設計パターンの検討と決定（ハイブリッドアプローチ採用）
  - [x] 設定構造の設計
  - [x] 基本設計ドキュメントの作成

### 進行中

- [ ] コア機能の実装
  - [ ] 各ルールの実装
    - **注意**: 実装済みルールの一覧は、規模が大きくなるため本READMEには含めていません。
      - どうしても必要ならば、全てを読み込まなくてよいようなツールを新規に作成します。
    - `npm run agent:rules:next` で次に実装するルールの情報を取得
      - コマンドが失敗したら、実装は完了
    - ruleNameに注目する
    - `npm run agent:rules:scaffold -- --ruleName "<ルール名>"` でルールの雛形を生成、ルールを実装する。
      - ルール名はエスケープされている場合があるが、元の名前を指定する。

#### ルール開発のガイドライン

1. テストの実装

   - 各ルールには対応するテストを実装する
   - テストは以下のパターンを含むべき:
     - 正常系: 対象の機能が十分にサポートされている場合
     - 異常系: 対象の機能がサポートされていない場合
     - エッジケース: 特殊な状況での動作
   - 常に実装上で検知すべきASTの種別の特定には次のツールを使用:
     - `npm run agent:ast:acorn` でASTを生成
     - `npm run agent:ast:typescript` でTypeScriptのASTを生成

2. 機能の判定方法

   - シンタックスレベルの機能は、その構文で判定:
     - 例: `import` 文は `ImportDeclaration` ノードで判定
     - 例: `class` 文は `ClassDeclaration` ノードで判定
     - 例: `async` 関数は `FunctionDeclaration` ノードで判定
   - オブジェクトやメンバーの存在確認は型情報を使用:
     - 例: `AggregateError` は `AggregateError` 型で判定
     - 例: `AggregateError.prototype.errors` は `.errors` へのアクセスのレシーバが `AggregateError` 型のオブジェクトかどうかで判定

3. コード品質と実装原則

   - 最小限かつ効率的な実装を心がける:
     - 重複するハンドラーはできるだけ避ける（例: `CallExpression`で捕捉可能な場合は、別途`ForOfStatement`などで再度検出する必要はない）
     - 同じノードに対して複数回のエラー報告を避ける
     - 複雑なロジックは共通の関数に抽出し、可読性を高める
   - ASTの構造を理解し、最も効率的な検出方法を選択する:
     - メソッド呼び出しは基本的に`CallExpression`で捕捉できる
     - 抽象度の高い検出（例: 特定のパターン）ではなく、具体的な構文要素で検出する

4. 実装上の制約

   - seedPathのファイルへの参照をルール内に持つことは禁止

5. 実装フロー

   - テストを実装しながら開発を進める
   - 実装の完了には次の3つが正常終了することを確認する
     - `npm run test` でテストを実行し、動作を確認
     - `npm run lint` でコードの整形と静的解析を実行
     - `npm run typecheck` で型チェックを実行
   - 3つのコマンドの正常終了を確認したら、`src/index.ts` にルールを追加
   - **必ず** 作業内容を以下の手順でコミットする:
     1. `git status` で変更ファイルを確認
     2. `git add` で必要なファイルをステージングに追加
     3. `git commit -m "feat: Add [ルール名] rule implementation"` でコミット
     4. コミットが成功したことを確認

   **注意**: コミットを忘れると作業内容が保存されません。実装完了後は必ずコミットしましょう。

その他の実装項目:

- [ ] 統合ルールの実装
- [ ] 設定ファクトリ関数の実装
- [ ] ディテクターの実装
- [ ] キャッシング機構の実装

### 予定

- [ ] 追加機能

  - [ ] 個別ルールのテンプレート作成
  - [ ] パフォーマンス最適化
  - [ ] エラーメッセージのローカライズ
  - [ ] CSS機能のサポート（別プラグインとして）

- [ ] ドキュメント
  - [ ] API リファレンス
  - [ ] 設定ガイド
  - [ ] 貢献ガイド
  - [ ] プラグイン分割ガイドライン

## 設計方針

詳細な設計ドキュメントは[devDocs](./devDocs)を参照してください。

- コアとなる機能は統合ルールで提供
  - 一般的なECMAScript機能のサポート検証
  - パフォーマンスを重視したキャッシング機構
- 特殊なケースは個別ルールで対応
  - 特別な検証ロジックが必要な機能
  - CSSなど、異なるドメインの機能
- 柔軟な設定システム
  - グローバル設定とオーバーライド設定をサポート
  - 機能ごとの細かい制御が可能

## エージェント向け開発用ツール

### ASTの解析

- `npm run agent:ast:acorn` - Acornを使用してASTを生成

  - `--code "<コード>"` コードを文字列で与える
  - `--jsx` JSXを有効にする
  - 出力: AST（JSON形式）

- `npm run agent:ast:typescript` - TypeScript ESTreeを使用してASTを生成
  - `--code "<コード>"` コードを文字列で与える
  - `--jsx` JSXを有効にする
  - 出力: AST（JSON形式）と型情報

### ルール開発

- `npm run agent:rules:next` - 次に実装するルールの情報を取得

  - 出力:
    - `ruleName`: 実装すべきルール名
    - `description`: ルールの説明
    - `seedPath`: 機能のサポート状況データへのパス
  - 注意: すべてのルールが実装済みの場合はエラーを返します

- `npm run agent:rules:scaffold --ruleName <ルール名>`
  - 指定されたルール名で新しいルールの雛形を生成
  - 生成されるファイル:
    - `src/rules/<ルール名>.ts`: ルールの実装
    - `test/rules/<ルール名>.test.ts`: テストファイル
  - テンプレートには基本的なルール構造とテストケースが含まれます
